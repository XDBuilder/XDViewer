<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XDViewer</title>
    <style>
        #map {
            position: absolute;
            width: calc(100%);
            height: calc(100%);
            left: 0px;
            top: 0px;
            box-shadow: 0 0 0 0px #aaa;
            /* 외곽선 효과를 그림자처럼 적용 */
            transition: border-color 0.3s;
        }

        #interface {
            display: block;
            position: absolute;
            z-index: 9;
            background-color: rgba(255, 255, 255, 0);
            /* 배경을 투명하게 설정 */
            padding: 0;
            border-radius: 0px;
            font-size: 10px;
            font-weight: bold;
            opacity: 1;
            margin: 0;
            width: 200px;
            /* 인터페이스 너비 설정 */
        }

        /* 작은 진한 바다색 버튼 스타일 */
        #interface button {
            display: block;
            /* 버튼을 한 줄에 하나씩 배치 */
            width: auto;
            /* 버튼 너비 자동 조정 */
            margin-bottom: 8px;
            /* 버튼 간 간격 설정 */
            background-color: #006B8F;
            /* 진한 바다색 배경 */
            color: #FFFFFF;
            /* 버튼 텍스트 색 */
            border: none;
            /* 기본 테두리 제거 */
            border-radius: 8px;
            /* 둥근 모서리 */
            padding: 4px 12px;
            /* 세로 크기를 줄여서 작은 버튼 크기 설정 */
            font-size: 12px;
            /* 폰트 크기 설정 */
            cursor: pointer;
            /* 버튼 클릭 시 포인터로 변경 */
            text-align: center;
            /* 텍스트 가운데 정렬 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            /* 기본 그림자 추가 */
            transition: all 0.3s ease;
            /* 부드러운 전환 효과 */
        }

        /* hover 효과 */
        #interface button:hover {
            background-color: #008C9E;
            /* hover 시 밝은 바다색 */
            transform: translateY(-2px);
            /* hover 시 버튼 위로 살짝 올라감 */
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            /* hover 시 그림자 강조 */
        }

        /* active (클릭) 상태 */
        #interface button:active {
            transform: translateY(2px);
            /* 클릭 시 버튼이 눌리는 효과 */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            /* 클릭 시 그림자 감소 */
        }

        * {
            outline: none;
        }

        .dragover {
            box-shadow: 0 0 0 2px #00aaff;
            /* 드래그 시 외곽선 색상 변경 */
        }
    </style>
</head>

<body>
    <!-- 지도 표시 영역 -->
    <div id='map'></div>

    <!-- 사용자 인터페이스 영역 -->
    <div id="interface" onmouseout="mouseOverInterface(false);" onmouseover="mouseOverInterface(true);">
        <!-- 레이어 열기 버튼 -->
        <button id="openLayer">Open</button>
    </div>

    <script>
        index = 0;
        // 랜덤 색상 생성 함수
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // Electron에서 파일 경로 수신 시 처리
        window.electronAPI.onFilePathReceived((event, filePath) => {
            // 파일 경로에서 file:/// 접두어 제거
            if (filePath.startsWith("file:///")) {
                filePath = filePath.replace("file:///", "");
            }else if(filePath.startsWith("File:///")) {
                filePath = filePath.replace("File:///", "");
            }
            filePath = filePath.replace(/\\/g, '/'); // 역슬래시를 슬래시로 변경

            // 새로운 레이어 생성
            let layerList = new Module.JSLayerList(true);
            let layer = layerList.createLayer("_LAYER_" + index, Module.ELT_3DTILES);
            layer.import3DTiles({
                url: filePath,  // 첫 번째 파일 경로를 사용
                autoMove: true,
            });
            //Module.getTerrain().demRate = 0.001; // DEM 축소 비율 설정
            layer.setPointCloudPointSize(0.01); // 포인트 클라우드 크기 설정

            // 새 버튼 생성
            const newButton = document.createElement('button');
            newButton.textContent = '_LAYER_' + index; // 새 버튼 텍스트 설정

            // 새 버튼 클릭 시 레이어 제거
            newButton.addEventListener('click', () => {
                Module.XDEMapRemoveLayer(newButton.textContent); // 레이어 제거 함수 호출
                console.log(newButton.textContent);
                newButton.remove(); // 버튼 제거
                mouseOverInterface(false); // 마우스 오버 상태 해제
            });

            // 랜덤 색상으로 새 버튼 배경 설정
            newButton.style.backgroundColor = getRandomColor();
            // 새 버튼을 인터페이스에 추가
            document.getElementById('interface').appendChild(newButton);
            index++;
        });

        // 파일 선택 버튼 클릭 시 메인 프로세스에 파일 선택 요청
        document.getElementById('openLayer').addEventListener('click', async () => {
            window.electronAPI.openFileDialog(); // 메인 프로세스의 파일 선택 다이얼로그 호출
        });

        // 인터페이스 마우스 오버 상태 설정
        function mouseOverInterface(_isOver) {
            if (typeof Module == "object") {
                Module.XDIsMouseOverDiv(_isOver);
            }
        }

        // 창 크기 변경 시 처리
        window.onresize = function (e) {
            if (typeof Module == 'object') {
                if (typeof Module.Resize == 'function') {
                    Module.Resize(window.innerWidth, window.innerHeight); // 모듈 크기 조정
                    Module.XDRenderData(); // 데이터 렌더링
                }
            }
        };

        // XDWorld 모듈 설정
        var Module = {
            locateFile: function (s) {
                return "https://cdn.xdworld.kr/latest/" + s; // 모듈 파일 경로 설정
            },
            postRun: function () {
                Module.initialize({
                    container: document.getElementById("map"), // 지도 컨테이너 설정
                    terrain: {
                        dem: {
                            url: "https://xdworld.vworld.kr",
                            name: "dem",
                            servername: "XDServer3d",
                            encoding: true
                        },
                        image: {
                            url: "https://xdworld.vworld.kr",
                            name: "tile",
                            servername: "XDServer3d"
                        }
                    },
                    worker: {
                        use: true, // 워커 사용 여부
                        path: "./worker/XDWorldWorker.js", // 워커 파일 경로
                        count: 5 // 워커 수
                    },
                    defaultKey: "DFG~iaEpHmEpCrD5QpEQf2#FBSDJFmdzHoe(fB4!e1E(JS1I==" // 기본 키 설정
                });
/*
                // 기본 타일 레이어 설정
                var layerSimple = Module.getTileLayerList().createXDServerLayer({
                    url: "https://xdworld.vworld.kr",
                    servername: "XDServer3d",
                    name: "facility_build",
                    type: 9,
                    minLevel: 0,
                    maxLevel: 15
                });
                Module.setVisibleRange("facility_build", 3.0, 100000.0); // 가시 범위 설정

                // 간단 모드 설정
                Module.getMap().setSimpleMode(true);
                Module.getViewCamera().setLocation(new Module.JSVector3D(126.9, 37.5, 300.0)); // 초기 카메라 위치 설정
                Module.getViewCamera().setTilt(30); // 카메라 기울기 설정
*/                
            }
        };

        // XDWorld 스크립트 동적 로드
        var script = document.createElement('script');
        script.src = "https://cdn.xdworld.kr/latest/XDWorldEM.js";
        document.body.appendChild(script);
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</body>

</html>
